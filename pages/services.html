<div class="container mx-auto px-4 py-8">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8">
        <h1 class="text-3xl font-bold mb-4 md:mb-0">خدمات ما</h1>
        <div class="flex flex-wrap gap-4">
            <select id="category-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="">همه دسته‌بندی‌ها</option>
            </select>
            <div class="relative">
                <input 
                    type="text" 
                    id="search-input" 
                    placeholder="جستجوی خدمات..." 
                    class="px-4 py-2 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 w-full md:w-64"
                >
                <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
            </div>
        </div>
    </div>

    <!-- Services Grid -->
    <div id="services-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        <!-- Services will be loaded here dynamically -->
    </div>

    <!-- Pagination -->
    <div id="pagination" class="flex justify-center mt-12 space-x-2 space-x-reverse">
        <!-- Pagination buttons will be generated here -->
    </div>
</div>

<script>
// Initialize services page
function initServicesPage() {
    loadCategories();
    loadServices();
    
    // Add event listeners
    document.getElementById('category-filter').addEventListener('change', loadServices);
    const searchInput = document.getElementById('search-input');
    const debouncedSearch = uiHelper.debounce(loadServices, 300);
    searchInput.addEventListener('input', () => debouncedSearch());
}

// Load categories for filter
function loadCategories() {
    const categories = storage.getAllCategories();
    const categoryFilter = document.getElementById('category-filter');
    
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category.id;
        option.textContent = category.name;
        categoryFilter.appendChild(option);
    });
}

// Load services with filters
function loadServices() {
    const categoryFilter = document.getElementById('category-filter').value;
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    
    let services = storage.getAllServices();
    
    // Apply filters
    if (categoryFilter) {
        services = services.filter(service => service.category_id == categoryFilter);
    }
    
    if (searchTerm) {
        services = services.filter(service => 
            service.title.toLowerCase().includes(searchTerm) || 
            service.description.toLowerCase().includes(searchTerm)
        );
    }
    
    renderServices(services);
}

// Render services in grid
function renderServices(services) {
    const servicesGrid = document.getElementById('services-grid');
    
    if (services.length === 0) {
        servicesGrid.innerHTML = `
            <div class="col-span-full text-center py-12">
                <i class="fas fa-box-open text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-600 mb-2">خدمتی یافت نشد</h3>
                <p class="text-gray-500">خدمت مورد نظر شما وجود ندارد یا با فیلترهای اعمال‌شده مطابقت ندارد.</p>
            </div>
        `;
        return;
    }
    
    servicesGrid.innerHTML = services.map(service => {
        const category = storage.getAllCategories().find(cat => cat.id === service.category_id);
        return `
            <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-shadow">
                <div class="p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-bold mb-2">${service.title}</h3>
                            <span class="inline-block bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full">
                                ${category ? category.name : 'دسته‌بندی نشده'}
                            </span>
                        </div>
                        <div class="text-blue-600 text-3xl">
                            <i class="fas fa-coffee"></i>
                        </div>
                    </div>
                    <p class="text-gray-600 mb-4">${service.description}</p>
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-semibold text-blue-600">${formatCurrency(service.price)}</span>
                        <button 
                            onclick="showServiceDetails(${service.id})"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors"
                        >
                            مشاهده جزئیات
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Show service details modal
function showServiceDetails(serviceId) {
    const service = storage.getAllServices().find(s => s.id === serviceId);
    if (!service) return;
    
    const category = storage.getAllCategories().find(cat => cat.id === service.category_id);
    
    let optionsHtml = '';
    if (service.options && service.options.length > 0) {
        optionsHtml = `
            <div class="mt-4 space-y-4">
                <h4 class="font-semibold">گزینه‌های موجود:</h4>
                ${service.options.map(option => `
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">${option.name}</label>
                        <select class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                onchange="updatePrice(${service.id})" id="option-${option.id}">
                            ${option.values.map((value, idx) => `
                                <option value="${idx}">${value}</option>
                            `).join('')}
                        </select>
                    </div>
                `).join('')}
            </div>
        `;
    }
    
    const modalContent = `
        <div class="mb-4">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-2xl font-bold">${service.title}</h3>
                    <span class="inline-block bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full mt-2">
                        ${category ? category.name : 'دسته‌بندی نشده'}
                    </span>
                </div>
                <div class="text-blue-600 text-4xl">
                    <i class="fas fa-coffee"></i>
                </div>
            </div>
            <p class="text-gray-600 mb-4">${service.description}</p>
            ${optionsHtml}
            <div class="mt-6 pt-4 border-t">
                <div class="flex justify-between items-center">
                    <span class="text-lg">قیمت نهایی:</span>
                    <span id="final-price" class="text-2xl font-bold text-blue-600">${formatCurrency(service.price)}</span>
                </div>
                <button 
                    onclick="addToCart(${service.id})"
                    class="w-full mt-4 bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors font-semibold"
                >
                    افزودن به سبد
                </button>
            </div>
        </div>
    `;
    
    modal.show({
        title: 'جزئیات خدمت',
        content: modalContent,
        size: 'lg'
    });
    
    // Store service for price calculation
    window.currentService = service;
    updatePrice(service.id);
}

// Update price based on selected options
function updatePrice(serviceId) {
    if (!window.currentService) return;
    
    let totalPrice = window.currentService.price;
    
    // Calculate additional costs from options
    if (window.currentService.options) {
        window.currentService.options.forEach((option, optIndex) => {
            const selectElement = document.getElementById(`option-${option.id}`);
            if (selectElement) {
                const selectedIndex = parseInt(selectElement.value);
                if (selectedIndex >= 0 && selectedIndex < option.prices.length) {
                    totalPrice += option.prices[selectedIndex];
                }
            }
        });
    }
    
    const priceElement = document.getElementById('final-price');
    if (priceElement) {
        priceElement.textContent = formatCurrency(totalPrice);
    }
}

// Add service to cart
function addToCart(serviceId) {
    // In a real implementation, we would add to cart
    // For now, just show a confirmation
    modal.hide();
    toast.success('خدمت با موفقیت به سبد اضافه شد');
}

// Initialize the page when loaded
if (window.uiHelper) {
    initServicesPage();
}
</script>